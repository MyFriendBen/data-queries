name: RLS Post-Hook Enforcement

on:
  pull_request:
    paths:
      - "dbt/models/postgres/marts/**"

jobs:
  check-rls-hooks:
    name: Check mart models for RLS post-hook
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check mart models for RLS post-hook
        run: |
          shopt -s nullglob
          MARTS_DIR="dbt/models/postgres/marts"
          non_compliant=()

          mapfile -t files < <(find "$MARTS_DIR" -name "*.sql" -type f)
          if [ ${#files[@]} -eq 0 ]; then
            echo "â„¹ï¸  No mart models found under $MARTS_DIR"
            exit 0
          fi
          for file in "${files[@]}"; do
            model=$(basename "$file" .sql)

            # Allow explicit opt-out via 'no-rls' tag
            if grep -qE "(tags\s*=\s*\[.*'no-rls'|'no-rls'.*tags\s*=\s*\[)" "$file"; then
              echo "â„¹ï¸  $model opted out of RLS via 'no-rls' tag"
              continue
            fi

            # Check for the required post-hook
            if ! grep -v '^\s*--' "$file" | grep -q "setup_white_label_rls"; then
              non_compliant+=("$model")
            fi
          done

          if [ ${#non_compliant[@]} -gt 0 ]; then
            echo ""
            echo "ðŸš¨ RLS ENFORCEMENT FAILURE"
            echo "The following mart models are missing the required white label RLS post-hook:"
            for model in "${non_compliant[@]}"; do
              echo "  - $model"
            done
            echo ""
            echo "To fix, add this to each model's config block:"
            echo '  post_hook="{{ setup_white_label_rls(this.name) }}"'
            echo ""
            echo "If a model genuinely doesn't need RLS, add the tag 'no-rls':"
            echo "  tags=['no-rls']"
            exit 1
          fi

          echo "âœ… All mart models have the required RLS post-hook."
